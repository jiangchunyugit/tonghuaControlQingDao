<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.thinkfree.database.mapper.PcUserInfoMapper">

    <resultMap id="AccountListVO" type="cn.thinkfree.database.vo.account.AccountListVO">
        <id column="id" property="id" />
        <result column="name" property="name"/>
        <result column="people_number" property="account"/>
        <result column="people_group" property="dept"/>
        <result column="company_name" property="branchCompanyName"/>
        <result column="city_branch_name" property="cityBranchCompanyName"/>
        <result column="enabled" property="state"/>
        <result column="create_time" property="createTime"/>
        <result column="phone" property="phone"/>
        <result column="email" property="email"/>
        <result column="roles" property="roles"/>
    </resultMap>

    <resultMap id="pcUserInfoVo" type="cn.thinkfree.database.vo.PcUserInfoVo" extends="BaseResultMap">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <result column="login_time" jdbcType="TIMESTAMP" property="lastLogin" />
        <result column="password" jdbcType="VARCHAR" property="password" />
        <result column="company_name" jdbcType="TIMESTAMP" property="companyName" />
        <result column="regPhone" jdbcType="VARCHAR" property="regPhone" />
    </resultMap>


    <select id="selectByParam" parameterType="java.util.List" resultMap="pcUserInfoVo">
        select
        <include refid="Base_Column_List" />
        from pc_user_info
        where 1=1
        <if test="list != null">
            and company_id in <foreach item="item" index="index" collection="list" open="(" separator="," close=")">
                                    #{item}
                                </foreach>
        </if>
    </select>

    <select id="findByParam" parameterType="java.util.Map" resultMap="pcUserInfoVo">
        select pc.id,pc.name, pc.phone, pc.memo, pc.enabled,pc.is_delete, pc.company_id,
        log.login_time, reg.phone regPhone, com.company_name,pc.create_time
        from pc_user_info pc
        left join (select phone, max(login_time) login_time from user_login_log
        group by phone) log on pc.phone = log.phone left join user_register reg on pc.id = reg.user_id
        left join company_info com on pc.company_id = com.company_id where 1=1 and reg.is_delete = 0
        <if test="param != null and param != ''">
            and (pc.name like #{param} or pc.phone like #{param})
        </if>
        <if test="companyId != null">
            and pc.company_id in <foreach item="item" index="index" collection="companyId" open="(" separator="," close=")">
            #{item}
        </foreach>
        </if>
        order by to_char(pc.create_time, 'YYYY/MM/DD') desc
    </select>

    <select id="findByUserId" parameterType="java.lang.String" resultMap="pcUserInfoVo">
        select users.*, com.company_name from company_info com
        join (select pc.*, re.password
        from pc_user_info pc join user_register re on pc.id = re.user_id and pc.id = #{userId,jdbcType=VARCHAR}) users
        on com.company_id = users.company_id
    </select>

    <update id="updateById" parameterType="cn.thinkfree.database.vo.PcUserInfoVo">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update pc_user_info
        <set>
            <if test="name != null">
                name = #{name,jdbcType=VARCHAR},
            </if>
            <if test="phone != null">
                phone = #{phone,jdbcType=VARCHAR},
            </if>
            <if test="memo != null">
                memo = #{memo,jdbcType=VARCHAR},
            </if>
            <if test="creator != null">
                creator = #{creator,jdbcType=VARCHAR},
            </if>
            <if test="createTime != null">
                create_time = #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="enabled != null">
                enabled = #{enabled,jdbcType=SMALLINT},
            </if>
            <if test="isDelete != null">
                is_delete = #{isDelete,jdbcType=SMALLINT},
            </if>
            <if test="companyId != null">
                company_id = #{companyId,jdbcType=VARCHAR},
            </if>
            <if test="rootCompanyId != null">
                root_company_id = #{rootCompanyId,jdbcType=VARCHAR},
            </if>
            <if test="parentCompanyId != null">
                parent_company_id = #{parentCompanyId,jdbcType=VARCHAR},
            </if>
            <if test="level != null">
                level = #{level,jdbcType=SMALLINT},
            </if>
            <if test="province != null">
                province = #{province,jdbcType=VARCHAR},
            </if>
            <if test="city != null">
                city = #{city,jdbcType=VARCHAR},
            </if>
            <if test="area != null">
                area = #{area,jdbcType=VARCHAR},
            </if>
        </set>
        where id = #{id,jdbcType=VARCHAR}
    </update>

    <insert id="insertUserInfoVo" parameterType="cn.thinkfree.database.vo.PcUserInfoVo">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into pc_user_info
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="name != null">
                name,
            </if>
            <if test="phone != null">
                phone,
            </if>
            <if test="memo != null">
                memo,
            </if>
            <if test="creator != null">
                creator,
            </if>
            <if test="createTime != null">
                create_time,
            </if>
            <if test="enabled != null">
                enabled,
            </if>
            <if test="isDelete != null">
                is_delete,
            </if>
            <if test="companyId != null">
                company_id,
            </if>
            <if test="rootCompanyId != null">
                root_company_id,
            </if>
            <if test="parentCompanyId != null">
                parent_company_id,
            </if>
            <if test="level != null">
                level,
            </if>
            <if test="province != null">
                province,
            </if>
            <if test="city != null">
                city,
            </if>
            <if test="area != null">
                area,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id,jdbcType=VARCHAR},
            </if>
            <if test="name != null">
                #{name,jdbcType=VARCHAR},
            </if>
            <if test="phone != null">
                #{phone,jdbcType=VARCHAR},
            </if>
            <if test="memo != null">
                #{memo,jdbcType=VARCHAR},
            </if>
            <if test="creator != null">
                #{creator,jdbcType=VARCHAR},
            </if>
            <if test="createTime != null">
                #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="enabled != null">
                #{enabled,jdbcType=SMALLINT},
            </if>
            <if test="isDelete != null">
                #{isDelete,jdbcType=SMALLINT},
            </if>
            <if test="companyId != null">
                #{companyId,jdbcType=VARCHAR},
            </if>
            <if test="rootCompanyId != null">
                #{rootCompanyId,jdbcType=VARCHAR},
            </if>
            <if test="parentCompanyId != null">
                #{parentCompanyId,jdbcType=VARCHAR},
            </if>
            <if test="level != null">
                #{level,jdbcType=SMALLINT},
            </if>
            <if test="province != null">
                #{province,jdbcType=VARCHAR},
            </if>
            <if test="city != null">
                #{city,jdbcType=VARCHAR},
            </if>
            <if test="area != null">
                #{area,jdbcType=VARCHAR},
            </if>
        </trim>
    </insert>


    <select id="selectAccountListVO" parameterType="cn.thinkfree.database.vo.account.AccountSEO" resultMap="AccountListVO">
        SELECT
            pc_user_info."name",
            pc_user_info."id",
            pc_user_info.create_time,
            pc_user_info.enabled,
            pc_user_info.email,
            pc_user_info.phone,
            pc_user_info.branch_company_id,
            pc_user_info.city_branch_company_id,
            pc_city_branch.city_branch_name,
            pc_branch_company.company_name,
            hr_people_entity.people_group,
            hr_people_entity.people_number,
            (
                  SELECT
                    array_to_string(
                      ARRAY (
                        SELECT
                          pc_system_role.name
                        FROM
                          pc_system_role pc_system_role
                        JOIN pc_system_user_role pc_system_user_role ON pc_system_role.ID = pc_system_user_role.role_id
                        AND pc_system_user_role.user_id = pc_user_info."id"
                      ),
                    ','
                    )
                ) AS roles
        FROM
            pc_user_info pc_user_info
        JOIN hr_people_entity hr_people_entity on pc_user_info.third_id = hr_people_entity.id
        LEFT JOIN pc_branch_company pc_branch_company on pc_branch_company."branch_company_code" = pc_user_info.branch_company_id
        LEFT JOIN pc_city_branch pc_city_branch on pc_city_branch."city_branch_code" = pc_user_info.city_branch_company_id
        WHERE pc_user_info.is_delete = 0

        <if test="branchCompany != null and '' neq branchCompany ">
            and pc_branch_company.branch_company_code = #{branchCompany}
        </if>
        <if test="cityBranch != null and '' neq cityBranch">
            and pc_city_branch.city_branch_code = #{cityBranch}
        </if>
        <if test="dept != null and '' neq dept">
            and pc_branch_company.id = #{dept}
        </if>
        <if test="name != null and '' neq name">

            and
            (pc_user_info.name like concat(#{name},'%')
              or pc_user_info.phone like concat(#{name},'%')
             )
        </if>
        <if test="state != null and '' neq state">
            and pc_user_info.enabled = #{state}
        </if>
    </select>
    <!-- 查询账号详情  -->
    <select id="selectAccountVOByID">

    </select>
</mapper>